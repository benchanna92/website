<!DOCTYPE html>
<html lang="ms" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jualan Bulanan</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    :root {
      --color-primary: #111827;
      --color-text: #374151;
      --color-gray-light: #f9fafb;
      --color-gray-medium: #6b7280;
      --color-bg: #ffffff;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      --transition: 0.3s ease;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      position: sticky;
      top: 0;
      background: var(--color-bg);
      border-bottom: 1px solid #e5e7eb;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-weight: 700;
      font-size: 1.5rem;
      color: var(--color-primary);
      user-select: none;
      letter-spacing: 0.05em;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto 4rem;
      padding: 0 1rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-weight: 700;
      font-size: 2.75rem;
      margin-bottom: 0.25rem;
      color: var(--color-primary);
      user-select: none;
    }

    h2 {
      font-weight: 600;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .text-muted {
      color: var(--color-gray-medium);
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      user-select: none;
    }

    .tab {
      padding: 0.5rem 1.25rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--color-gray-medium);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: color var(--transition), border-color var(--transition);
      background: none;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .tab[aria-selected="true"] {
      color: var(--color-primary);
      border-color: var(--color-primary);
      cursor: default;
    }

    form {
      background: var(--color-gray-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem 1.75rem;
      margin-bottom: 2rem;
      max-width: 400px;
      width: 100%;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      font-size: 1rem;
      border: 1.5px solid #d1d5db;
      border-radius: var(--radius);
      transition: border-color var(--transition);
      font-family: 'Inter', system-ui, sans-serif;
      margin-bottom: 1rem;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: #111827;
      box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.15);
    }

    button {
      background-color: var(--color-primary);
      color: white;
      font-weight: 600;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius);
      font-size: 1rem;
      cursor: pointer;
      transition: background-color var(--transition), transform var(--transition);
      user-select: none;
      width: 100%;
    }
    button:hover,
    button:focus {
      background-color: #374151;
      transform: scale(1.05);
      outline: none;
    }

    .login-register-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 70vh;
      width: 100%;
      max-width: 420px;
    }

    .dashboard {
      display: none;
      flex-direction: column;
      width: 100%;
      max-width: 1200px;
    }

    .summary {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
      justify-content: center;
    }

    .card {
      background: var(--color-gray-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem;
      flex: 1;
      min-width: 150px;
      max-width: 300px;
      color: var(--color-primary);
      text-align: center;
      user-select: none;
    }

    .card h3 {
      margin: 0 0 0.5rem 0;
      font-weight: 700;
      font-size: 1.25rem;
    }

    .chart-section {
      background: var(--color-gray-light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem 2rem;
      max-width: 800px;
      margin: 0 auto 3rem;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .chart-tabs {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1.25rem;
      user-select: none;
    }

    .chart-tab {
      padding: 0.45rem 1.5rem;
      font-weight: 600;
      font-size: 1.15rem;
      color: var(--color-gray-medium);
      border-bottom: 3px solid transparent;
      cursor: pointer;
      transition: color var(--transition), border-color var(--transition);
      background: none;
      border-radius: var(--radius) var(--radius) 0 0;
      min-width: 90px;
      text-align: center;
    }
    .chart-tab[aria-selected="true"] {
      color: var(--color-primary);
      border-color: var(--color-primary);
      cursor: default;
    }

    canvas {
      width: 100% !important;
      max-width: 800px;
      height: 400px !important;
      user-select: none;
    }

    .logout-btn {
      align-self: flex-end;
      margin-bottom: 1.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      background-color: #ef4444;
      max-width: 120px;
      user-select: none;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background-color var(--transition), transform var(--transition);
    }
    .logout-btn:hover,
    .logout-btn:focus {
      background-color: #b91c1c;
      transform: scale(1.05);
      outline: none;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 2rem;
      }
      .summary {
        flex-direction: column;
        align-items: center;
      }
      .card {
        max-width: 100%;
      }
      .chart-tab {
        min-width: 75px;
        font-size: 1rem;
        padding: 0.45rem 1rem;
      }
    }
  </style>
</head>
<body>
<header>
  <nav>
    <div class="logo" tabindex="0">Penjejakan Jualan Bulanan</div>
  </nav>
</header>
<main>
  <section class="login-register-container" aria-label="Bahagian log masuk dan pendaftaran pengguna">
    <h1 id="authTitle">Log Masuk</h1>
    <div role="tablist" aria-label="Tab pengesahan" class="tabs">
      <button role="tab" aria-selected="true" tabindex="0" id="loginTab" class="tab">Log Masuk</button>
      <button role="tab" aria-selected="false" tabindex="-1" id="registerTab" class="tab">Daftar</button>
    </div>
    <form id="login-form" aria-label="Borang log masuk" novalidate>
      <label for="login-username">Nama Pengguna</label>
      <input type="text" id="login-username" name="username" required autocomplete="username" autofocus />
      <label for="login-password">Kata Laluan</label>
      <input type="password" id="login-password" name="password" required autocomplete="current-password" />
      <button type="submit" aria-label="Log masuk">Log Masuk</button>
    </form>

    <form id="register-form" aria-label="Borang pendaftaran" style="display:none" novalidate>
      <label for="register-username">Nama Pengguna</label>
      <input type="text" id="register-username" name="username" required autocomplete="username" />
      <label for="register-password">Kata Laluan</label>
      <input type="password" id="register-password" name="password" required autocomplete="new-password" />
      <label for="register-password-confirm">Sahkan Kata Laluan</label>
      <input type="password" id="register-password-confirm" name="passwordConfirm" required autocomplete="new-password" />
      <button type="submit" aria-label="Daftar akaun">Daftar</button>
    </form>
  </section>

  <section class="dashboard" aria-label="Papan pemuka jualan">
    <button class="logout-btn" id="logoutBtn" aria-label="Log keluar">Log Keluar</button>
    <h2>Selamat Datang, <span id="userDisplayName"></span>!</h2>
    <form id="sales-form" aria-label="Tambah jualan baru" novalidate>
      <h2>Tambah Jualan Baru</h2>
      <label for="product">Produk</label>
      <input type="text" id="product" name="product" required />
      <label for="price">Harga (RM)</label>
      <input type="number" id="price" name="price" min="0.01" step="0.01" required />
      <label for="date">Tarikh</label>
      <input type="date" id="date" name="date" required />
      <button type="submit" aria-label="Tambah jualan">Tambah</button>
    </form>

    <section class="summary" aria-label="Ringkasan jualan bulanan">
      <div class="card">
        <h3>Jumlah Jualan</h3>
        <p id="totalSales">RM&nbsp;0.00</p>
      </div>
      <div class="card">
        <h3>Bilangan Transaksi</h3>
        <p id="numTransactions">0</p>
      </div>
      <div class="card">
        <h3>Harga Purata Jualan</h3>
        <p id="avgPrice">RM&nbsp;0.00</p>
      </div>
    </section>

    <section class="chart-section" aria-label="Bahagian carta jualan">
      <div role="tablist" aria-label="Tab jenis carta" class="chart-tabs">
        <button role="tab" aria-selected="true" tabindex="0" id="dailyTab" class="chart-tab">Harian</button>
        <button role="tab" aria-selected="false" tabindex="-1" id="monthlyTab" class="chart-tab">Bulanan</button>
        <button role="tab" aria-selected="false" tabindex="-1" id="yearlyTab" class="chart-tab">Tahunan</button>
      </div>
      <canvas id="salesChart" aria-label="Carta jualan"></canvas>
    </section>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script>
(() => {
  const USERS_KEY = 'trackingSales_users';
  const SALES_DATA_KEY = 'trackingSales_sales';

  // Elements
  const loginRegisterContainer = document.querySelector('.login-register-container');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const loginTab = document.getElementById('loginTab');
  const registerTab = document.getElementById('registerTab');
  const authTitle = document.getElementById('authTitle');

  const dashboard = document.querySelector('.dashboard');
  const userDisplayName = document.getElementById('userDisplayName');
  const logoutBtn = document.getElementById('logoutBtn');

  const salesForm = document.getElementById('sales-form');
  const totalSalesEl = document.getElementById('totalSales');
  const numTransactionsEl = document.getElementById('numTransactions');
  const avgPriceEl = document.getElementById('avgPrice');
  const salesChartCtx = document.getElementById('salesChart').getContext('2d');

  const dailyTab = document.getElementById('dailyTab');
  const monthlyTab = document.getElementById('monthlyTab');
  const yearlyTab = document.getElementById('yearlyTab');
  const chartTabs = [dailyTab, monthlyTab, yearlyTab];

  let currentUser = null;
  let salesData = [];
  let chartInstance = null;
  let currentChartType = 'daily'; // default chart type on login

  // User storage functions
  function loadUsers() {
    const usersRaw = localStorage.getItem(USERS_KEY);
    return usersRaw ? JSON.parse(usersRaw) : {};
  }
  function saveUsers(users) {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }

  function loadSalesData() {
    if (!currentUser) return [];
    const allSalesRaw = localStorage.getItem(SALES_DATA_KEY);
    if (!allSalesRaw) return [];
    const allSales = JSON.parse(allSalesRaw);
    return allSales[currentUser] || [];
  }
  function saveSalesData(sales) {
    if (!currentUser) return;
    const allSalesRaw = localStorage.getItem(SALES_DATA_KEY);
    const allSales = allSalesRaw ? JSON.parse(allSalesRaw) : {};
    allSales[currentUser] = sales;
    localStorage.setItem(SALES_DATA_KEY, JSON.stringify(allSales));
  }

  // Tab switching (login/register)
  function switchToLogin() {
    loginTab.setAttribute('aria-selected', 'true');
    loginTab.tabIndex = 0;
    registerTab.setAttribute('aria-selected', 'false');
    registerTab.tabIndex = -1;
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
    authTitle.textContent = 'Log Masuk';
    clearRegisterFormErrors();
  }
  function switchToRegister() {
    loginTab.setAttribute('aria-selected', 'false');
    loginTab.tabIndex = -1;
    registerTab.setAttribute('aria-selected', 'true');
    registerTab.tabIndex = 0;
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    authTitle.textContent = 'Daftar';
    clearLoginFormErrors();
  }

  loginTab.addEventListener('click', () => {
    switchToLogin();
  });
  registerTab.addEventListener('click', () => {
    switchToRegister();
  });

  // Keyboard accessible tab switching
  loginTab.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault();
      registerTab.focus();
      switchToRegister();
    }
  });
  registerTab.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault();
      loginTab.focus();
      switchToLogin();
    }
  });

  // Login form submit
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    clearLoginFormErrors();

    const username = loginForm.username.value.trim();
    const password = loginForm.password.value;

    if (!username || !password) {
      alert('Sila masukkan nama pengguna dan kata laluan.');
      return;
    }

    const users = loadUsers();
    if (!users[username]) {
      alert('Pengguna tidak wujud. Sila daftar.');
      return;
    }
    if (users[username] !== password) {
      alert('Kata laluan salah.');
      return;
    }

    loginSuccess(username);
  });

  // Register form submit
  registerForm.addEventListener('submit', e => {
    e.preventDefault();
    clearRegisterFormErrors();

    const username = registerForm.username.value.trim();
    const password = registerForm.password.value;
    const passwordConfirm = registerForm.passwordConfirm.value;

    if (!username || !password || !passwordConfirm) {
      alert('Sila isi semua ruangan.');
      return;
    }
    if (password !== passwordConfirm) {
      alert('Kata laluan tidak sepadan.');
      return;
    }

    const users = loadUsers();
    if (users[username]) {
      alert('Nama pengguna telah diambil. Sila pilih yang lain.');
      return;
    }

    // Register user
    users[username] = password;
    saveUsers(users);
    alert('Pendaftaran berjaya! Sila log masuk.');
    switchToLogin();
    loginForm.username.value = username;
    loginForm.password.value = '';
    loginForm.username.focus();
  });

  // Helper clear form errors (placeholder)
  function clearLoginFormErrors() {}
  function clearRegisterFormErrors() {}

  // Login success handler
  function loginSuccess(username) {
    currentUser = username;
    loginRegisterContainer.style.display = 'none';
    dashboard.style.display = 'flex';
    userDisplayName.textContent = username;
    currentChartType = 'monthly'; // Papar carta bulanan secara default selepas log masuk
    updateChartTabsSelection();
    loadAndRenderSales();
    saveCurrentUser();
  }

  // Logout handler
  logoutBtn.addEventListener('click', () => {
    logout();
  });
  function logout() {
    currentUser = null;
    salesData = [];
    loginRegisterContainer.style.display = 'flex';
    dashboard.style.display = 'none';
    loginForm.reset();
    registerForm.reset();
    switchToLogin();
    clearLoginFormErrors();
    clearRegisterFormErrors();
    saveCurrentUser();
  }

  // Sales form handling
  salesForm.addEventListener('submit', e => {
    e.preventDefault();
    const product = salesForm.product.value.trim();
    const price = parseFloat(salesForm.price.value);
    const date = salesForm.date.value;

    if (!product || isNaN(price) || price <= 0 || !date) {
      alert('Sila masukkan produk, harga (> 0), dan tarikh yang sah.');
      return;
    }

    const sale = { product, price, date };
    salesData.push(sale);
    saveSalesData(salesData);
    salesForm.reset();

    loadAndRenderSales();
  });

  // Chart tabs handlers
  dailyTab.addEventListener('click', () => {
    if (currentChartType !== 'daily') {
      currentChartType = 'daily';
      updateChartTabsSelection();
      updateChart(salesData);
    }
  });
  monthlyTab.addEventListener('click', () => {
    if (currentChartType !== 'monthly') {
      currentChartType = 'monthly';
      updateChartTabsSelection();
      updateChart(salesData);
    }
  });
  yearlyTab.addEventListener('click', () => {
    if (currentChartType !== 'yearly') {
      currentChartType = 'yearly';
      updateChartTabsSelection();
      updateChart(salesData);
    }
  });

  // Keyboard navigation for chart tabs
  chartTabs.forEach((tab, i) => {
    tab.addEventListener('keydown', e => {
      if (['ArrowLeft', 'ArrowUp'].includes(e.key)) {
        e.preventDefault();
        const prevIndex = (i - 1 + chartTabs.length) % chartTabs.length;
        chartTabs[prevIndex].focus();
        chartTabs[prevIndex].click();
      } else if (['ArrowRight', 'ArrowDown'].includes(e.key)) {
        e.preventDefault();
        const nextIndex = (i + 1) % chartTabs.length;
        chartTabs[nextIndex].focus();
        chartTabs[nextIndex].click();
      }
    });
  });

  function updateChartTabsSelection() {
    chartTabs.forEach(tab => {
      tab.setAttribute('aria-selected', tab.id.startsWith(currentChartType) ? 'true' : 'false');
      tab.tabIndex = tab.getAttribute('aria-selected') === 'true' ? 0 : -1;
    });
  }

  // Load sales and update UI/chart
  function loadAndRenderSales() {
    salesData = loadSalesData();

    updateSummary(salesData);
    updateChart(salesData);
  }

  function updateSummary(sales) {
    const total = sales.reduce((acc, s) => acc + s.price, 0);
    const count = sales.length;
    const avg = count ? total / count : 0;

    totalSalesEl.textContent = `RM\u00A0${total.toFixed(2)}`;
    numTransactionsEl.textContent = count.toString();
    avgPriceEl.textContent = `RM\u00A0${avg.toFixed(2)}`;
  }

  function groupSalesBy(sales, period) {
    // period: 'daily', 'monthly', 'yearly'
    const grouped = {};
    sales.forEach(({ price, date }) => {
      let key;
      if (period === 'daily') {
        key = date;
      } else if (period === 'monthly') {
        key = date.slice(0,7);
      } else if (period === 'yearly') {
        key = date.slice(0,4);
      }
      grouped[key] = (grouped[key] || 0) + price;
    });
    return grouped;
  }

  function updateChart(sales) {
    const period = currentChartType;
    const groupedData = groupSalesBy(sales, period);

    const keys = Object.keys(groupedData).sort();

    let labels = [];
    if (period === 'daily') {
      labels = keys.map(k => {
        const d = new Date(k + 'T00:00:00');
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      });
    } else if (period === 'monthly') {
      labels = keys.map(k => {
        const [year, month] = k.split('-');
        const d = new Date(year, month - 1);
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short' });
      });
    } else if (period === 'yearly') {
      labels = keys;
    }

    const values = keys.map(k => groupedData[k]);

    if (chartInstance) {
      chartInstance.data.labels = labels;
      chartInstance.data.datasets[0].data = values;
      chartInstance.data.datasets[0].label = `Jualan (${capitalize(period)}) (RM)`;
      chartInstance.update();
    } else {
      chartInstance = new Chart(salesChartCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `Jualan (${capitalize(period)}) (RM)`,
            data: values,
            borderColor: '#111827',
            backgroundColor: 'rgba(17, 24, 39, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6,
          }],
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'nearest',
            intersect: false,
          },
          scales: {
            x: {
              ticks: {
                color: '#374151',
                maxRotation: 45,
                minRotation: 45,
                autoSkip: true,
                maxTicksLimit: 12,
              },
              title: {
                display: true,
                text: period === "daily" ? 'Tarikh' : (period === 'monthly' ? 'Bulan' : 'Tahun'),
                color: '#374151',
                font: {weight: '600', size: 14}
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                color: '#374151',
                callback: function(value) {
                  return 'RM ' + value.toFixed(2);
                }
              },
              title: {
                display: true,
                text: 'Jualan (RM)',
                color: '#374151',
                font: {weight: '600', size: 14}
              }
            },
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#374151',
                font: {
                  weight: '600',
                  size: 14,
                },
              },
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: context => `RM ${context.parsed.y?.toFixed(2) ?? 0}`,
              }
            },
          },
        },
      });
    }
  }

  function capitalize(s) {
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  const storedUser = sessionStorage.getItem('trackingSales_currentUser');
  if (storedUser) {
    currentUser = storedUser;
    loginRegisterContainer.style.display = 'none';
    dashboard.style.display = 'flex';
    userDisplayName.textContent = currentUser;
    currentChartType = 'monthly';
    updateChartTabsSelection();
    loadAndRenderSales();
  } else {
    switchToLogin();
    loginRegisterContainer.style.display = 'flex';
    dashboard.style.display = 'none';
  }

  function saveCurrentUser() {
    if (currentUser) {
      sessionStorage.setItem('trackingSales_currentUser', currentUser);
    } else {
      sessionStorage.removeItem('trackingSales_currentUser');
    }
  }
})();
</script>
</body>
</html>


